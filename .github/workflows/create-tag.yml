# Create a versioned tag when a PR from translation-{lang_code}-{version} into local-{lang_code} is merged.
# Tag format: {version}-{lang_code}-{repo}-translation (e.g. boost-1.89.0-zh_Hans-algorithm-translation).
# Skipped if the tag already exists.
# Workflow must exist on the default branch (master).

name: create-tag

on:
  pull_request:
    types: [closed]
    branches: ['local-*']

permissions:
  contents: write

jobs:
  create-tag:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'translation-')
    steps:
      - name: Extract version and lang_code from branches
        id: tagname
        run: |
          HEAD_REF="${{ github.event.pull_request.head.ref }}"
          BASE_REF="${{ github.event.pull_request.base.ref }}"
          REPO="${{ github.event.repository.name }}"

          # lang_code from base branch: local-zh_Hans -> zh_Hans
          LANG_CODE="${BASE_REF#local-}"

          # version from head branch: translation-zh_Hans-boost-1.89.0 -> strip "translation-${LANG_CODE}-boost-" -> 1.89.0
          VERSION_FULL="${HEAD_REF#translation-${LANG_CODE}-}"
          VERSION="${VERSION_FULL#boost-}"

          # e.g. boost-1.89.0-zh_Hans-algorithm-translation
          TAGNAME="boost-${VERSION}-${LANG_CODE}-${REPO}-translation"
          echo "tagname=$TAGNAME" >> "$GITHUB_OUTPUT"

      - name: Checkout local-{lang_code} branch with tags
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: Create and push tag
        run: |
          TAGNAME="${{ steps.tagname.outputs.tagname }}"
          if git tag -l "$TAGNAME" | grep -q "^${TAGNAME}$"; then
            echo "Tag $TAGNAME already exists, skipping."
            exit 0
          fi
          git config user.name "Boost-Translation-CI-Bot"
          git config user.email "Boost-Translation-CI-Bot@cppdigest.local"
          git tag "$TAGNAME"
          git push origin "$TAGNAME"
